---
title: "flexdashboard"
output: 
  flexdashboard::flex_dashboard:
    orientation: columns
    vertical_layout: fill
    css: style.css
---

```{r setup, include=FALSE}
library(flexdashboard)
library(tidyverse)
library(readxl)
library(readr)
library(rvest)
library(stringr)
library(tidytext)
library(wordcloud)
library(RColorBrewer)
library(treemap)
library(ggplot2)
library(ggmap)
library(plotly)
library(treemap)
library(d3treeR)
# devtools::install_github("timelyportfolio/d3treeR")
```

```{r map, message=FALSE, warning=FALSE, include=F}
state_17 <- read_xlsx("./data/state/oesm17st/state_M2017_dl.xlsx") %>% 
  janitor::clean_names() %>% 
  mutate(a_mean = as.numeric(a_mean)) %>%
  mutate(tot_emp = as.numeric(tot_emp))

## Missing data replaced by mean salary in that specific detailed field for annual salary 
state_df <-  
  state_17 %>% 
  mutate(a_mean = ifelse(is.na(a_mean), mean(a_mean, na.rm = TRUE), a_mean)) %>% 
  mutate(state = tolower(state))    ## To match the case of state names in 2 dataframe 


## Add state salary df.
state_salary <- 
  state_df %>%
  filter(str_detect(occ_code, "15-0000") ) %>% 
  filter(!state %in% c("Puerto Rico","Guam", "Virgin Islands")) %>% 
  group_by(state) %>%
  summarize(abb = st,
            mean_salary = a_mean,
            mean_total = tot_emp,
            mean_job = round(as.numeric(jobs_1000), 2))

## By using map plotly
states_map <- map_data("state")

state_salary$hover <- 
  with(state_salary, paste(
    "Salary: $", round(mean_salary, 2),'<br>',
            "Total:", mean_total, '<br>',
            "DS Jobs per 1000:", mean_job,'<br>'))

# give state boundaries a white border
l <- list(color = toRGB("white"), width = 2)
# specify some map projection/options
g <- list(
  scope = 'usa',
  projection = list(type = 'albers usa'),
  showlakes = TRUE,
  lakecolor = toRGB('white')
)
```


```{r treemap, message=FALSE, warning=FALSE, include=F}
datascience <- read_csv("./data/ds_500.csv") %>% 
  filter(!is.na(position))

pattern_bg = c("[Cc]omputer [Ss]cience | \\bC\\.?S\\b | [Mm]achine [Ll]earning | \\bM\\.?L\\b", 
                 "[Ss]tatistic", 
                 "[Mm]ath", 
                 "[Qq]uantitative", 
                 "[Ee]conomic", 
                 "[Bb]iolog", 
                 "[Bb]iostatis", 
                 "[Dd]ata [Ss]cience | \\bD\\.?S\\b", 
                 "[Cc]hemical [Ee]ngineering")
name_bg = c("CS", 
          "Statistics", 
          "Mathematics", 
          "Quantitative", 
          "Economics", 
          "Biology", 
          "Biostatistics", 
          "DS", 
          "Engineer")

bg_freq = data.frame(
  background = pattern_bg, 
  index = name_bg, 
  freq_total = rep(0, length(pattern_bg)), 
  top500 = rep(0, length(pattern_bg)), 
  nontop500 = rep(0, length(pattern_bg)) 
)

for (i in c(1:length(pattern_bg))) {
  bg_freq$freq_total[i] = sum(str_detect(datascience$description, as.character(bg_freq$background[i])))
  bg_freq$top500[i] = sum(str_detect(datascience$description[which(datascience$flag == 1)], as.character(bg_freq$background[i])))
  bg_freq$nontop500[i] = sum(str_detect(datascience$description[which(datascience$flag == 0)], as.character(bg_freq$background[i])))
}

bg_freq = 
  bg_freq %>% 
  gather(key = subgroup, value = freq, top500:nontop500) %>% 
  mutate(freq_ratio = ifelse(subgroup == "top500", freq/sum(datascience$flag == 1), freq/sum(datascience$flag == 0))) %>% 
  mutate(subgroup = paste("In ", subgroup, ": n(companies) = ", freq, ", ratio = ", round(freq_ratio, digits = 3), sep = ""))

p = 
treemap(
    bg_freq,
    index = c("index", "subgroup"), 
    vSize = "freq_ratio", 
    vColor = "freq_ratio", 
    type = "value",
    palette = "Blues"
    )
```

```{r salary and vacancy, message=FALSE, warning=FALSE, include=F}
#read national Occupational Employment Statistics data
read_national_data = function(file_yr) {
  df = 
  read_excel(str_c("data/national_10yr/national_", file_yr, ".xls")) %>% 
  janitor::clean_names() %>% 
  filter(str_detect(occ_code, "0000$")) %>%
  mutate(year = file_yr) %>% 
  mutate(a_mean = as.numeric(a_mean), 
         a_median = as.numeric(a_median),
         tot_emp = as.numeric(tot_emp),
         mean_prse = as.numeric(mean_prse)) %>% 
  select(year, tot_emp, occ_code, occ_title, a_mean, mean_prse, a_median) 
  
  df
}

#aggregate all 10 years' data in one data frame
national_df = map_df(2008:2017, read_national_data) %>% unnest()

#tidy occupation titles
national_df = 
national_df %>% 
  mutate(occ_title = tolower(occ_title)) %>% 
  mutate(occ_title = str_replace(occ_title, 
                                 "computer and mathematical science occupations", 
                                 "computer and mathematical occupations"),
         occ_title = str_replace(occ_title, 
                                 "community and social service occupations", 
                                 "community and social services occupations"),
         occ_title = str_replace(occ_title, 
                                 "healthcare practitioner and technical occupations", 
                                 "healthcare practitioners and technical occupations")) 
```


Column {data-width=600}
-----------------------------------------------------------------------

### Chart A

```{r}
plot_geo(state_salary, locationmode = 'USA-states') %>%
  add_trace(
    z = ~ mean_salary, text = ~hover, locations = ~ abb,
    color = ~ mean_salary, colors = 'Oranges'
  ) %>%
  colorbar(title = "$:USD") %>%
  layout(
    title = '2017 US Data Science jobs info by State<br>Source: <a href="https://www.bls.gov/oes/tables.htm">BLS</a>',
    titlefont = 8,
    geo = g, 
    legend = list(x = 0.1, y = 0.1, orientation = 'h')
  )
```

### Chart B

```{r}
d3tree(p, rootname = "General")
```


Column {data-width=400, .tabset}
-----------------------------------------------------------------------

### Chart C

```{r}

```

### Chart D

```{r}
national_df %>%
  filter(occ_code != "15-0000") %>% 
  group_by(year) %>% 
  arrange(desc(tot_emp)) %>%
  ggplot(aes(x = year, y = a_median, color = occ_title))+
  geom_line()+
  geom_point()+
  geom_line(data = filter(national_df, occ_code == "15-0000"), color = "black")+
  geom_point(data = filter(national_df, occ_code == "15-0000"), color = "black")+
  labs(x = "Year",
       y = "Mean Annual Salary in dollars",
       color = "Occupation\nTitle",
       title = "10-year trend of median annual salary change across different occupations in the U.S",
       caption = "(based on data from Bureau of Labor Statistics)") +
  scale_x_continuous(breaks = c(2007, 2009, 2011, 2013, 2015, 2017)) +
  theme(legend.position="bottom", 
        legend.text = element_text(size=8))+
  guides(colour = guide_legend(nrow = 8))
```

