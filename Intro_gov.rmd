---
title: "Intro_gov_sj.rmd"
author: "Shan Jiang"
date: "11/24/2018"
output: github_document
---

## Data: May 2017 National Occupational Employment and Wage Estimates United States>

## Salary Prospect From 2017 

```{r}
library(tidyverse)
library(readxl)

```


```{r 10 yr trend across occupations}

library(readxl)

#read data from national level
read_national_data = function(file_yr) {
  df = 
  read_excel(str_c("data/national_10yr/national_", file_yr, ".xlsx")) %>% 
  janitor::clean_names() %>% 
  filter(str_detect(occ_code, "0000$")) %>%
  mutate(year = file_yr) %>% 
  mutate(a_mean = as.numeric(a_mean), 
         a_median = as.numeric(a_median),
         tot_emp = as.numeric(tot_emp),
         mean_prse = as.numeric(mean_prse)) %>% 
  select(year, tot_emp, occ_code, occ_title, a_mean, mean_prse, a_median) 
  
  df
}

#create a tibble for all 10 years' data
national_df = map_df(2008:2017, read_national_data) %>% unnest()

#10 major occupation fields with most total emploment in 2017
national_df %>% filter(year == 2017, occ_code != "00-0000") %>% arrange(desc(tot_emp)) %>% head(n=10)


national_df %>%
  filter(occ_code %in% c("00-0000", 
                         "43-0000",
                         "35-0000",
                         "53-0000",
                         "51-0000",
                         "25-0000",
                         "29-0000",
                         
                         "15-0000",)) %>% 
  group_by(year) %>% 
  arrange(desc(tot_emp)) %>%
  ggplot(aes(x = year, y = a_mean, color = occ_code))+
  geom_line()+
  geom_point()+
  labs(x = "Year",
       y = "Mean Annual Salary in dollars",
       title = "10-year trend of mean annual salary change across different occupations in the U.S") +
  scale_colour_discrete(name ="Occupation\nTitle",
                      breaks = c("00-0000", "13-0000", "15-0000", "17-0000", "19-0000", "29-0000", "41-0000"),
                      labels = c("All Occupations", "Business and Financial Operations", "Computer and Mathematical", "Architecture and Engineering", "Life, Physical, and Social Science", "Healthcare Practitioners and Technical", "Sales and Related"))

```


```{r plotting increment rate}
national_df %>% 
  group_by(occ_code) %>% 
  arrange(year) %>% 
  mutate(increment = ifelse(year == 2008 ,0, diff(tot_emp, 1,1))) %>% 
  mutate(increment_p = increment / tot_emp) %>% 
  filter(occ_code %in% c("13-0000",
                         "15-0000",
                         "17-0000",
                         "19-0000",
                         "29-0000",
                         "41-0000",
                         "00-0000")) %>%
  ggplot(aes(x = year, y = increment_p, color = occ_code))+
  geom_point(aes(size = a_median,  alpha=0.4))+
  scale_size(range = c(0,11))+
  geom_line()+
  labs(size = "Median Annual Salary")+
  scale_colour_discrete(name ="Occupation\nTitle",
                      breaks = c("00-0000", "13-0000", "15-0000", "17-0000", "19-0000", "29-0000", "41-0000"),
                      labels = c("All Occupations", "Business and Financial Operations", "Computer and Mathematical", "Architecture and Engineering", "Life, Physical, and Social Science", "Healthcare Practitioners and Technical", "Sales and Related")) +
  scale_alpha(guide = 'none')

```



## Geographical plots and maps 

Import data of state level.

```{r}
state_17 <- read_xlsx("./data/state/oesm17st/state_M2017_dl.xlsx") %>% 
  janitor::clean_names() %>% 
  mutate(a_mean = as.numeric(a_mean)) %>%
  mutate(tot_emp = as.numeric(tot_emp))

## Missing data replaced by mean salary in that specific detailed field for annual salary 
state_df <-  
  state_17 %>% View()
  mutate(a_mean = ifelse(is.na(a_mean), mean(a_mean, na.rm = TRUE), a_mean)) %>% 
  mutate(state = tolower(state))    ## To match the case of state names in 2 dataframe 
```

Then we need to combine the datasets from us.state map and our data.  

```{r}
state_df %>% 
  distinct(state) %>% 
  pull(state) 
```

Since we are making the map of the U.S, we have `nrow(state_17)` entries in our dataset, then we may choose to leave out the data of **Guam**, **Virgin Islands** and the **Puerto Rico** in the convenience of visualization. 

Also, it is far too difficult to create a U.S. state data visualization in R that includes Alaska and Hawaii. 

Then we only keep the computer and mathmatician job classification in our data. 

### spatial map 

```{r}
## Add state salary df.
state_salary <- 
  state_df %>%
  filter(str_detect(occ_code, "15-0000") ) %>% 
  filter(!state %in% c("Puerto Rico","Guam", "Virgin Islands")) %>% 
  group_by(state) %>%
  summarize(abb = st,
            mean_salary = a_mean,
            mean_total = tot_emp,
            mean_job = round(as.numeric(jobs_1000), 2))

```

Now we have `nrow(state_clean)` entries in our dataframe. 

Then we need to generate the geographical information for our dataset. 

```{r}
library(ggplot2)
library(ggmap)
library(fiftystater)
library(plotly)
 
## By using map plotly
states_map <- map_data("state")

state_salary$hover <- 
  with(state_salary, paste(
    "Salary: $", round(mean_salary, 2),'<br>',
            "Total:", mean_total, '<br>',
            "DS Jobs per 1000:", mean_job,'<br>'))

# give state boundaries a white border
l <- list(color = toRGB("white"), width = 2)
# specify some map projection/options
g <- list(
  scope = 'usa',
  projection = list(type = 'albers usa'),
  showlakes = TRUE,
  lakecolor = toRGB('white')
)

p <- plot_geo(state_salary, locationmode = 'USA-states') %>%
  add_trace(
    z = ~ mean_salary, text = ~hover, locations = ~ abb,
    color = ~ mean_salary, colors = 'Oranges'
  ) %>%
  colorbar(title = "$:USD") %>%
  layout(
    title = '2017 US Data Science jobs info by State<br>Source: <a href="https://www.bls.gov/oes/tables.htm">BLS</a>',
    titlefont = 8,
    geo = g
  )

```



## Add team logo 
```{r}
sticker(imgurl2, 
        package = "DS Job Outlook", 
        p_size = 6, s_x = 1.05, s_y = 0.75, s_width =.8,
        h_color = "#000000",  p_color = "black",
        filename = "./data/Figures/team_logo2.png")


```


