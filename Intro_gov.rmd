---
title: "Intro_gov_sj.rmd"
author: "Shan Jiang"
date: "11/24/2018"
output: github_document
---

## Data: May 2017 National Occupational Employment and Wage Estimates United States>

## Salary Prospect From 2017 

```{r}
library(tidyverse)
library(readxl)

```


```{r}

national_17 <- read_excel("data/oesm17nat/national_M2017_dl.xlsx")

national_17 %>% View()

national_17 = national_17 %>% 
              janitor::clean_names() %>% 
              filter(str_detect(occ_code, "^[1][5]") | 
                    occ_title == "All Occupations" | 
                    str_detect(occ_code, "^[1][3]") | 
                    str_detect(occ_code, "^[1][9]")) %>% 
              arrange(desc(tot_emp), a_mean)

## Annual Average comparison for different majors 
national_17 %>% 
              janitor::clean_names() %>% 
              filter(occ_group == "major" | occ_group == "total") %>% 
              mutate(occ_title = as.factor(occ_title)) %>% 
              arrange(desc(tot_emp), a_mean) %>% 
              mutate(CI_salary_low = a_mean - mean_prse, 
                     CI_salary_high = a_mean + mean_prse ) %>% 
  ggplot(aes(occ_title, a_mean)) +
    geom_point() + 
  geom_errorbar(ymax = national_17$a_mean +  national_17$mean_rpse , 
                ymin =  national_17$a_mean -  national_17$mean_rpse) +
  theme_bw() +
  theme(legend.position = "bottom",
        legend.direction = "horizontal",
        axis.text.x = element_text(angle = 90, size = 8),
        legend.key.size = unit(0.05, "cm"))
  
              

national_17 %>% 
filter(occ_code == "13-0000" | 
                    occ_title == "All Occupations" | 
                    occ_code ==  "15-0000" | 
                    occ_code == "19-0000") %>% 
              arrange(desc(tot_emp), a_mean)
  

```

For detetcting the outlook of the computer and math category jobs, we carried out comparison with jobs in some popular fields, such as the 


## Geographical plots and maps 

Import data of state level.

```{r}
state_17 <- read_xlsx("./data/state/oesm17st/state_M2017_dl.xlsx") %>% 
  janitor::clean_names() %>% 
  mutate(a_mean = as.numeric(a_mean)) %>%
  mutate(tot_emp = as.numeric(tot_emp))

## Missing data replaced by mean salary in that specific detailed field for annual salary 
state_df <-  
  state_17 %>% 
  mutate(a_mean = ifelse(is.na(a_mean), mean(a_mean, na.rm = TRUE), a_mean)) %>% 
  mutate(state = tolower(state))    ## To match the case of state names in 2 dataframe 
```

Then we need to combine the datasets from us.state map and our data.  

```{r}
state_df %>% 
  distinct(state) %>% 
  pull(state) 
```

Since we are making the map of the U.S, we have `nrow(state_17)` entries in our dataset, then we may choose to leave out the data of **Guam**, **Virgin Islands** and the **Puerto Rico** in the convenience of visualization. 

Also, it is far too difficult to create a U.S. state data visualization in R that includes Alaska and Hawaii. 

Then we only keep the computer and mathmatician job classification in our data. 

### spatial map 

```{r}

state_salary <- 
  state_df %>%
  filter(str_detect(occ_code, "^[1][5]") ) %>% 
  filter(!state %in% c("Puerto Rico","Guam", "Virgin Islands")) %>% 
  group_by(state) %>%
  summarize(mean_salary = mean(a_mean))
  

statisticians_df = 
  state_df %>%
  filter(str_detect(occ_code, "^[1][5]") ) %>% 
  filter(!state %in% c("Puerto Rico","Guam", "Virgin Islands")) %>% 
  group_by(state, occ_title) %>% 
  filter(occ_title == "Statisticians")

place_df = statisticians_df %>% 
   select(state, occ_code, occ_title,tot_emp, a_mean, a_median) 
  
```

Now we have `nrow(state_clean)` entries in our dataframe. 

Then we need to generate the geographical information for our dataset. 

```{r}
library(ggplot2)
library(ggmap)
library(fiftystater)
library(plotly)

 p = state_salary %>% 
  ggplot(aes(map_id = state)) + 
  # map points to the fifty_states shape data
  geom_map(aes(fill =  mean_salary), map = fifty_states) + 
  expand_limits(x = fifty_states$long, y = fifty_states$lat) +
  coord_map() +
  scale_x_continuous(breaks = NULL) + 
  scale_y_continuous(breaks = NULL) +
  labs(x = "", y = "")
 

ggplotly(p)
 
## By using map plotly
states_map <- map_data("state")

state_salary  = state_salary %>% 
  mutate(text_label = str_c("Salary: $", round(mean_salary, 2))) 

 g <- ggplot(state_salary, aes(map_id = state)) + 
  # map points to the fifty_states shape data
  geom_map(aes(fill = mean_salary), map = states_map) + 
  expand_limits(x = states_map$long, y = states_map$lat) +
  scale_x_continuous(breaks = NULL) + 
  scale_y_continuous(breaks = NULL) +
  labs(x = "", y = "")  

ggplotly(g)

```




```{r}

us_state_map <- map_data("state") %>%
  as_data_frame()
 
ggplot(data = us_state_map) + 
  geom_polygon(aes(x = long, y = lat, fill = region, group = group), color = "white") + 
  coord_quickmap() +
  guides(fill = FALSE) 


plot_usmap(data = state_clean, values = "pop_2015", lines = "red") + 
  scale_fill_continuous(
    low = "white", high = "red", name = "Population (2015)", label = scales::comma
  ) + theme(legend.position = "right")

citation("ggmap")
```

